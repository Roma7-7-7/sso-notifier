name: Build and Test

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.x'

      - name: Install dependencies
        run: |
          go mod download

      - name: Run build
        run: make build

      - name: Run testing
        run: go test -coverprofile=coverage.out -v ./...

      - name: Check coverage badge matches actual coverage
        run: |
          ACTUAL_COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          
          # Extract coverage from README badge (handles both with and without color suffix)
          BADGE_COVERAGE=$(grep -o 'coverage-[0-9.]*%25' README.md | head -1 | sed 's/coverage-//;s/%25.*//')
          
          echo "Actual coverage: ${ACTUAL_COVERAGE}%"
          echo "Badge coverage: ${BADGE_COVERAGE}%"
          
          # Compare coverage values (exact match required)
          if [ "$ACTUAL_COVERAGE" != "$BADGE_COVERAGE" ]; then
            echo "❌ Coverage mismatch!"
            echo "Please update the coverage badge in README.md to match actual coverage (${ACTUAL_COVERAGE}%)"
            echo ""
            echo "Run the following command to update the badge:"
            echo "  ./scripts/update-coverage-badge.sh"
            exit 1
          fi
          
          echo "✅ Coverage badge is up to date!"

      - name: Run go vet
        run: go vet ./...